<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase Sohbet</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:0; display:flex; justify-content:center; align-items:center; height:100vh; }
  #container { background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); width:400px; padding:20px; }
  h2 { margin-top:0; }
  input[type=email], input[type=password], input[type=text] {
    width:100%; padding:10px; margin:6px 0 12px 0; border-radius:5px; border:1px solid #ccc; font-size:16px;
  }
  button { width:100%; padding:10px; background:#1877f2; color:white; font-size:16px; border:none; border-radius:5px; cursor:pointer; }
  button:disabled { background:#7a9ce6; cursor:not-allowed; }
  #chat { display:none; flex-direction: column; height: 500px; }
  #messages {
    flex:1;
    background:#e9ebee;
    padding:10px;
    border-radius:5px;
    overflow-y:auto;
    margin-bottom:10px;
  }
  #messages div {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 15px;
    background: #1877f2;
    color: white;
    max-width: 80%;
    word-wrap: break-word;
  }
  #messageInput { width: calc(100% - 50px); padding:10px; border-radius:20px; border:1px solid #ccc; }
  #sendBtn { width:40px; height:40px; background:#1877f2; border:none; border-radius:50%; color:white; cursor:pointer; margin-left:5px; }
  #activeUsers { margin-bottom: 10px; font-weight:bold; }
</style>
</head>
<body>

<div id="container">

  <!-- Kayıt ve Giriş ekranları -->
  <div id="auth">
    <h2 id="authTitle">Giriş Yap</h2>
    <input type="email" id="email" placeholder="E-posta" />
    <input type="password" id="password" placeholder="Şifre" />
    <button id="authBtn" disabled>Giriş Yap</button>
    <p id="toggleAuth" style="text-align:center; margin-top:15px; cursor:pointer; color:#1877f2;">
      Kayıt olmak için tıklayın
    </p>
    <p id="errorMsg" style="color:red; text-align:center;"></p>
  </div>

  <!-- Sohbet ekranı -->
  <div id="chat">
    <div id="activeUsers">Aktif Kullanıcılar: <span id="usersList"></span></div>
    <div id="messages"></div>
    <div style="display:flex;">
      <input id="messageInput" placeholder="Mesajınızı yazın..." />
      <button id="sendBtn">▶</button>
    </div>
    <button id="logoutBtn" style="margin-top:10px; background:#f44336;">Çıkış Yap</button>
  </div>

</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const authDiv = document.getElementById('auth');
  const chatDiv = document.getElementById('chat');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const authBtn = document.getElementById('authBtn');
  const toggleAuth = document.getElementById('toggleAuth');
  const authTitle = document.getElementById('authTitle');
  const errorMsg = document.getElementById('errorMsg');

  const usersListSpan = document.getElementById('usersList');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  let isRegisterMode = false;
  let currentUser = null;
  let activeUsersRef = null;
  let messagesRef = null;

  // Buton aktif/pasif
  function updateAuthBtn() {
    authBtn.disabled = !(emailInput.value.trim() && passwordInput.value.trim());
  }
  emailInput.addEventListener('input', updateAuthBtn);
  passwordInput.addEventListener('input', updateAuthBtn);

  toggleAuth.addEventListener('click', () => {
    isRegisterMode = !isRegisterMode;
    authTitle.textContent = isRegisterMode ? 'Kayıt Ol' : 'Giriş Yap';
    authBtn.textContent = isRegisterMode ? 'Kayıt Ol' : 'Giriş Yap';
    toggleAuth.textContent = isRegisterMode ? 'Giriş yapmak için tıklayın' : 'Kayıt olmak için tıklayın';
    errorMsg.textContent = '';
  });

  authBtn.addEventListener('click', () => {
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (isRegisterMode) {
      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          afterLogin();
        })
        .catch(err => { errorMsg.textContent = err.message; });
    } else {
      signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          afterLogin();
        })
        .catch(err => { errorMsg.textContent = err.message; });
    }
  });

  // Login sonrası
  function afterLogin() {
    authDiv.style.display = 'none';
    chatDiv.style.display = 'flex';

    // Aktif kullanıcıları ve mesajları dinle
    listenActiveUsers();
    listenMessages();

    // Aktif kullanıcı olarak ekle
    const userRef = ref(db, 'activeUsers/' + currentUser.uid);
    set(userRef, { email: currentUser.email, lastActive: serverTimestamp() });

    // Çıkış yapınca aktif kullanıcıdan çıkar
    window.addEventListener('beforeunload', () => {
      remove(userRef);
    });

    logoutBtn.addEventListener('click', () => {
      remove(userRef).then(() => signOut(auth));
    });
  }

  // Aktif kullanıcıları dinle
  function listenActiveUsers() {
    activeUsersRef = ref(db, 'activeUsers');
    onValue(activeUsersRef, snapshot => {
      const users = snapshot.val() || {};
      usersListSpan.textContent = Object.values(users).map(u => u.email).join(', ');
    });
  }

  // Mesajları dinle
  function listenMessages() {
    messagesRef = ref(db, 'messages');
    onValue(messagesRef, snapshot => {
      messagesDiv.innerHTML = '';
      const data = snapshot.val() || {};
      Object.values(data).forEach(msg => {
        const div = document.createElement('div');
        div.textContent = msg.email + ': ' + msg.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Mesaj gönder
  sendBtn.addEventListener('click', () => {
    sendMessage();
  });
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    push(ref(db, 'messages'), {
      email: currentUser.email,
      text,
      timestamp: serverTimestamp()
    });
    messageInput.value = '';
  }

  // Oturum durumunu kontrol et
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      afterLogin();
    } else {
      authDiv.style.display = 'block';
      chatDiv.style.display = 'none';
    }
  });
</script>

</body>
</html>
