<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GeliÅŸmiÅŸ Sohbet UygulamasÄ±</title>
<style>
  body{font-family:Arial,sans-serif;background:#f0f2f5;margin:0;padding:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
  #container{width:400px;max-width:95%;background:white;border-radius:8px;box-shadow:0 0 15px rgba(0,0,0,0.2);padding:20px;margin-top:20px;}
  input,button{font-size:16px}
  input[type=text]{width:100%;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #ccc;}
  input[type=file]{margin-bottom:10px;}
  button{width:100%;padding:10px;background:#1877f2;color:#fff;border:none;border-radius:5px;cursor:pointer;}
  button:disabled{background:#aaa;}
  #chat{display:none;flex-direction:column;}
  #userList{margin-bottom:10px;}
  .user-item{padding:8px;cursor:pointer;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
  .user-item:hover{background:#fafafa;}
  .user-item.active{background:#d4edda;}
  #messages{height:200px;background:#eee;padding:10px;overflow-y:auto;border-radius:6px;margin-bottom:10px;}
  .msg{display:flex;margin-bottom:6px;align-items:flex-end;}
  .msg img{width:30px;height:30px;border-radius:50%;margin-right:6px;}
  .msg .text{background:#1877f2;color:#fff;padding:8px;border-radius:10px;max-width:70%;}
  .msg.me .text{background:#d1e7dd;color:#333;}
  #notifSound{display:none;}
</style>
</head>
<body>
<div id="container">
  <div id="login">
    <h2>GiriÅŸ / KayÄ±t</h2>
    <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±" maxlength="15">
    <input type="file" id="avatarInput" accept="image/*">
    <button id="loginBtn" disabled>GiriÅŸ Yap</button><br>
    <small>KullanÄ±cÄ± adÄ± ve avatar ekleyin</small>
  </div>

  <div id="chat">
    <h3>Ã‡evrimiÃ§i KullanÄ±cÄ±lar</h3>
    <div id="userList"></div>
    <div id="messages"></div>
    <form id="msgForm" style="display:flex;">
      <input type="text" id="msgInput" placeholder="Mesaj..." autocomplete="off">
      <button type="submit">ðŸ“¨</button>
    </form>
    <button id="logoutBtn" style="background:#dc3545;margin-top:10px;">Ã‡Ä±kÄ±ÅŸ Yap</button>
  </div>
</div>
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, set, push, onValue, remove, serverTimestamp, get, child } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

  // Firebase config (senin)
  const firebaseConfig = {
    apiKey: "AIzaSyDoEh6kXDhwtbJV583Blzh_RN2dh1seyck",
    authDomain: "sohbet-31244.firebaseapp.com",
    databaseURL: "https://sohbet-31244-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "sohbet-31244",
    storageBucket: "sohbet-31244.appspot.com",
    messagingSenderId: "22460967347",
    appId: "1:22460967347:web:7fce6b4d75fd78bbac83c6",
    measurementId: "G-RDTHWG6FCR"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  let my = { userId:null, name:null, avatarURL:null };
  let currentChatId = null;

  const usernameInput = document.getElementById("username");
  const avatarInput = document.getElementById("avatarInput");
  const loginBtn = document.getElementById("loginBtn");
  const loginDiv = document.getElementById("login");
  const chatDiv = document.getElementById("chat");
  const userListDiv = document.getElementById("userList");
  const messagesDiv = document.getElementById("messages");
  const msgForm = document.getElementById("msgForm");
  const msgInput = document.getElementById("msgInput");
  const logoutBtn = document.getElementById("logoutBtn");
  const notifSound = document.getElementById("notifSound");

  usernameInput.oninput = () => loginBtn.disabled = !usernameInput.value.trim();
  avatarInput.onchange = () => loginBtn.disabled = !usernameInput.value.trim();

  loginBtn.onclick = async () => {
    my.name = usernameInput.value.trim();
    if (!my.name) return;
    loginBtn.disabled = true;

    // avatar upload
    if (avatarInput.files[0]) {
      const file = avatarInput.files[0];
      const path = 'avatars/'+Date.now()+'_'+file.name;
      const snap = await uploadBytes(sref(storage,path), file);
      my.avatarURL = await getDownloadURL(sref(storage,path));
    }

    my.userId = push(ref(db,'users')).key;
    await set(ref(db,'users/'+my.userId), {
      name: my.name,
      avatar: my.avatarURL || '',
      active:true
    });

    loginDiv.style.display='none';
    chatDiv.style.display='flex';
    requestNotificationPerm();
    listenUsers();
    listenMessages();
  };

  logoutBtn.onclick = () => {
    if (my.userId) remove(ref(db,'users/'+my.userId));
    location.reload();
  };

  window.onbeforeunload = () => {
    if (my.userId) remove(ref(db,'users/'+my.userId));
  };

  function listenUsers() {
    onValue(ref(db,'users'), snap => {
      const us = snap.val()||{};
      userListDiv.innerHTML = '';
      for (let id in us) {
        if (!us[id].active) continue;
        if (id===my.userId) continue;
        const u = us[id];
        const d = document.createElement('div');
        d.className='user-item';
        d.innerHTML = `
          <span>${u.name}</span>
          <img src="${u.avatar||'https://placehold.co/30'}" width=30 height=30 style="border-radius:50%;">
        `;
        d.onclick = ()=> selectChat(id,u.name);
        userListDiv.appendChild(d);
      }
    });
  }

  function selectChat(otherId, otherName) {
    currentChatId = [my.userId, otherId].sort().join('_');
    messagesDiv.innerHTML = '';
    document.querySelectorAll('.user-item').forEach(el=>el.classList.remove('active'));
    event.currentTarget?.classList.add('active');
  }

  msgForm.onsubmit = e => {
    e.preventDefault();
    if (!msgInput.value.trim() || !currentChatId) return;
    set(push(ref(db,'messages/'+currentChatId)), {
      from: my.name, avatar:my.avatarURL||'', text: msgInput.value.trim(),
      time: serverTimestamp()
    });
    msgInput.value='';
  };

  function listenMessages() {
    onValue(ref(db,'messages'), snap=>{
      messagesDiv.innerHTML='';
      const all = snap.val()||{};
      for (const chatId in all) {
        if (currentChatId!==chatId) continue;
        const msgs = all[chatId];
        for (let k in msgs) {
          const m = msgs[k];
          const div = document.createElement('div');
          div.className='msg '+(m.from===my.name?'me':'');
          div.innerHTML = `<img src="${m.avatar||'https://placehold.co/30'}"><div class="text">${m.from}: ${m.text}</div>`;
          messagesDiv.appendChild(div);
          if (m.from!==my.name) notifSound.play(), notify(`${m.from} mesaj gÃ¶nderdi`);
        }
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  function requestNotificationPerm(){
    if ('Notification' in window) Notification.requestPermission();
  }

  function notify(msg){
    if (document.visibilityState==='visible') return;
    if (Notification.permission==='granted'){
      new Notification(msg);
    }
  }

</script>
</body>
</html>
