<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sohbet Uygulaması</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    #app { max-width: 800px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #login-section, #chat-section { display: none; }
    #chat-window { display: flex; height: 400px; }
    #user-list { width: 30%; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; }
    #chat-area { width: 70%; padding: 10px; display: flex; flex-direction: column; }
    #messages { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; }
    .user { cursor: pointer; margin-bottom: 5px; }
    .user.active { font-weight: bold; }
    .message { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div id="app">
    <div id="login-section">
      <h2>Giriş Yap / Kayıt Ol</h2>
      <input type="text" id="username" placeholder="Kullanıcı Adı">
      <input type="password" id="password" placeholder="Şifre">
      <button id="login-btn">Giriş Yap</button>
      <button id="register-btn">Kayıt Ol</button>
      <p id="login-error" style="color:red;"></p>
    </div>

    <div id="chat-section">
      <h2>Sohbet</h2>
      <div id="chat-window">
        <div id="user-list"><strong>Aktif Kullanıcılar</strong></div>
        <div id="chat-area">
          <div id="messages"></div>
          <input type="text" id="message-input" placeholder="Mesajınızı yazın...">
          <button id="send-btn">Gönder</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoEh6kXDhwtbJV583Blzh_RN2dh1seyck",
      authDomain: "sohbet-31244.firebaseapp.com",
      databaseURL: "https://sohbet-31244-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbet-31244",
      storageBucket: "sohbet-31244.firebasestorage.app",
      messagingSenderId: "22460967347",
      appId: "1:22460967347:web:7fce6b4d75fd78bbac83c6",
      measurementId: "G-RDTHWG6FCR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null;
    let selectedUser = null;

    const loginSection = document.getElementById('login-section');
    const chatSection = document.getElementById('chat-section');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const messagesDiv = document.getElementById('messages');
    const userListDiv = document.getElementById('user-list');
    const loginError = document.getElementById('login-error');

    // Giriş / kayıt kontrol
    loginSection.style.display = 'block';

    registerBtn.onclick = () => {
      const uname = usernameInput.value.trim();
      const pass = passwordInput.value;
      if (!uname || !pass) return alert("Lütfen kullanıcı adı ve şifre girin.");
      const userRef = ref(db, 'users/' + uname);
      set(userRef, { password: pass, active: true });
      currentUser = uname;
      showChat();
    };

    loginBtn.onclick = () => {
      const uname = usernameInput.value.trim();
      const pass = passwordInput.value;
      if (!uname || !pass) return alert("Lütfen kullanıcı adı ve şifre girin.");

      const userRef = ref(db, 'users/' + uname);
      onValue(userRef, snapshot => {
        const userData = snapshot.val();
        if (!userData) {
          loginError.textContent = "Kullanıcı bulunamadı.";
        } else if (userData.password === pass) {
          update(userRef, { active: true });
          currentUser = uname;
          showChat();
        } else {
          loginError.textContent = "Şifre yanlış.";
        }
      }, { onlyOnce: true });
    };

    function showChat() {
      loginSection.style.display = 'none';
      chatSection.style.display = 'block';
      loadUsers();
      listenMessages();
    }

    function loadUsers() {
      const usersRef = ref(db, 'users');
      onValue(usersRef, snapshot => {
        userListDiv.innerHTML = "<strong>Aktif Kullanıcılar</strong>";
        const users = snapshot.val();
        for (let uname in users) {
          if (users[uname].active && uname !== currentUser) {
            const div = document.createElement('div');
            div.textContent = uname;
            div.className = 'user';
            if (uname === selectedUser) div.classList.add('active');
            div.onclick = () => {
              selectedUser = uname;
              document.querySelectorAll('.user').forEach(e => e.classList.remove('active'));
              div.classList.add('active');
              listenMessages();
            };
            userListDiv.appendChild(div);
          }
        }
      });
    }

    function listenMessages() {
      if (!selectedUser) return;
      const chatId = [currentUser, selectedUser].sort().join('_');
      const chatRef = ref(db, 'chats/' + chatId);
      onValue(chatRef, snapshot => {
        const data = snapshot.val();
        messagesDiv.innerHTML = '';
        for (let key in data) {
          const msg = data[key];
          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `<strong>${msg.from}:</strong> ${msg.text}`;
          messagesDiv.appendChild(div);
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    sendBtn.onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg || !selectedUser) return;
      const chatId = [currentUser, selectedUser].sort().join('_');
      const chatRef = ref(db, 'chats/' + chatId);
      push(chatRef, { from: currentUser, text: msg });
      messageInput.value = '';
    };

    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        const userRef = ref(db, 'users/' + currentUser);
        update(userRef, { active: false });
      }
    });
  </script>
</body>
</html>
